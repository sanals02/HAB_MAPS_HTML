<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø®Ø±ÙŠØ·Ø© Ø­ÙØ± Ø§Ù„Ø¨Ø§Ø·Ù† - Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
 
  <!-- Leaflet -->
<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: "TheSansArabic", sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .leaflet-popup-content {
      text-align: center;
      direction: rtl;
      font-size: 14px;
    }
</style>
</head>
 
<body>
<div id="map"></div>
 
  <script>
    // === Initialize map centered on Hafar Al-Batin ===
    const map = L.map("map", {
      center: [28.4322, 45.9708], // ğŸ™ï¸ City center
      zoom: 13,                   // â¬…ï¸ Matching Panel 1 zoom level
      minZoom: 10,
      maxZoom: 22,
      zoomControl: true,
    });
 
    // === ESRI World Street Map (Normal beige Arabic map) ===
    const esriStreet = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 19,
        attribution: "Â© Esri"
      }
    ).addTo(map);
 
    // === Marker handling ===
    let markers = [];
    let selectedMarker = null;
 
    // --- Receive data from Grafana ---
    window.addEventListener("message", (event) => {
      if (!event.data || event.data.type !== "habData") return;
 
      // Remove old markers
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
 
      const regionData = event.data.data || [];
      console.log("ğŸ“ [Panel 2] regionData received in map:", regionData);
      
      if (!regionData.length) return;
 
      // Add new markers
      regionData.forEach((r) => {
        const marker = L.circleMarker([r.lat, r.long], {
          radius: 8,
          color: "#ff0000",
          fillColor: "#ff0000",
          fillOpacity: 0.9,
          weight: 1.5,
        })
          .addTo(map)
          .bindPopup(`<b>${decodeURIComponent(r.name)}</b>`) // âœ… FIXED SYNTAX
          .on("click", () => {
            // Reset previous marker
            if (selectedMarker) {
              selectedMarker.setStyle({
                color: "#ff0000",
                fillColor: "#ff0000",
                radius: 8,
              });
            }
 
            // Highlight current marker
            marker.setStyle({
              color: "#ffff00",
              fillColor: "#ffff00",
              radius: 11,
            });
            selectedMarker = marker;
 
            // Send region to Grafana (without reload)
            window.parent.postMessage(
              {
                type: "mapClick",
                region: r.name, // Send encoded name
              },
              "*"
            );
          });
 
        markers.push(marker);
      });
 
      // Auto-zoom to fit all markers
      if (regionData.length > 1) {
        const bounds = L.latLngBounds(regionData.map((r) => [r.lat, r.long]));
        map.fitBounds(bounds, { padding: [40, 40] });
      }
    });
</script>
</body>
</html>
